generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["equivalentes_app"]
}

model TrackingEvent {
  id        String   @id @default(uuid())
  cid       String
  eventType String   @map("event_type")
  meta      Json?
  userAgent String?  @map("user_agent")
  ip        String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([cid, createdAt], map: "idx_tracking_events_cid_created_at")
  @@index([eventType, createdAt], map: "idx_tracking_events_event_created_at")
  @@map("tracking_events")
  @@schema("equivalentes_app")
}

model KcalFormula {
  id          String   @id
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  generatedPlans GeneratedPlan[]

  @@map("kcal_formulas")
  @@schema("equivalentes_app")
}

model ExchangeSystem {
  id          String   @id
  countryCode String   @map("country_code") @db.Char(2)
  name        String
  source      String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  subgroupSelectionPolicies   SubgroupSelectionPolicy[]
  kcalSelectionPolicies       KcalSelectionPolicy[]
  subgroupClassificationRules SubgroupClassificationRule[]
  generatedPlans              GeneratedPlan[]

  @@map("exchange_systems")
  @@schema("equivalentes_app")
}

model CountryState {
  countryCode String   @map("country_code") @db.Char(2)
  stateCode   String   @map("state_code")
  stateName   String   @map("state_name")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@id([countryCode, stateCode])
  @@map("country_states")
  @@schema("equivalentes_app")
}

model FoodExchangeOverride {
  foodId               Int      @map("food_id")
  systemId             String   @map("system_id")
  groupId              Int?     @map("group_id")
  subgroupId           Int?     @map("subgroup_id")
  equivalentPortionQty Decimal? @map("equivalent_portion_qty") @db.Decimal(10, 2)
  portionUnit          String?  @map("portion_unit")
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@id([foodId, systemId])
  @@map("food_exchange_overrides")
  @@schema("equivalentes_app")
}

model FoodGeoWeight {
  id          BigInt   @id @default(autoincrement())
  foodId      Int      @map("food_id")
  countryCode String   @map("country_code") @db.Char(2)
  stateCode   String?  @map("state_code")
  weight      Decimal  @default(0) @db.Decimal(10, 2)
  source      String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([countryCode, stateCode, foodId], map: "idx_food_geo_weights_country_state_food")
  @@map("food_geo_weights")
  @@schema("equivalentes_app")
}

model FoodProfileTag {
  id        BigInt   @id @default(autoincrement())
  foodId    Int      @map("food_id")
  tagType   String   @map("tag_type")
  tagValue  String   @map("tag_value")
  weight    Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([foodId, tagType], map: "idx_food_profile_tags_food_type")
  @@map("food_profile_tags")
  @@schema("equivalentes_app")
}

model SubgroupSelectionPolicy {
  id             BigInt   @id @default(autoincrement())
  systemId       String   @map("system_id")
  goal           String
  dietPattern    String   @map("diet_pattern")
  subgroupId     Int?     @map("subgroup_id")
  targetSharePct Decimal  @map("target_share_pct") @db.Decimal(5, 2)
  scoreAdjustment Decimal @map("score_adjustment") @db.Decimal(10, 2)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  system ExchangeSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([systemId, goal, dietPattern, subgroupId], map: "uq_subgroup_selection_policy_subgroup_id")
  @@index([systemId, goal, dietPattern], map: "idx_subgroup_selection_policy_lookup")
  @@map("subgroup_selection_policies")
  @@schema("equivalentes_app")
}

model KcalSelectionPolicy {
  id                   BigInt   @id @default(autoincrement())
  systemId             String   @unique(map: "uq_kcal_selection_policy_system") @map("system_id")
  lowTargetKcal        Int      @default(1600) @map("low_target_kcal")
  highTargetKcal       Int      @default(3000) @map("high_target_kcal")
  minTolerancePct      Decimal  @default(0.2) @map("min_tolerance_pct") @db.Decimal(5, 2)
  maxTolerancePct      Decimal  @default(0.6) @map("max_tolerance_pct") @db.Decimal(5, 2)
  minToleranceKcal     Int      @default(25) @map("min_tolerance_kcal")
  softPenaltyPer10Pct  Decimal  @default(2.5) @map("soft_penalty_per_10pct") @db.Decimal(6, 2)
  hardOutlierMultiplier Decimal @default(2.8) @map("hard_outlier_multiplier") @db.Decimal(6, 2)
  excludeHardOutliers  Boolean  @default(true) @map("exclude_hard_outliers")
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  system ExchangeSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@index([systemId, isActive], map: "idx_kcal_selection_policy_system_active")
  @@map("kcal_selection_policies")
  @@schema("equivalentes_app")
}

model SubgroupClassificationRule {
  id               BigInt   @id @default(autoincrement())
  systemId         String   @map("system_id")
  parentGroupId    Int?     @map("parent_group_id")
  subgroupId       Int?     @map("subgroup_id")
  minFatPer7gPro   Decimal  @map("min_fat_per_7g_pro") @db.Decimal(10, 4)
  maxFatPer7gPro   Decimal? @map("max_fat_per_7g_pro") @db.Decimal(10, 4)
  priority         Int
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  system ExchangeSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([systemId, parentGroupId, subgroupId, priority], map: "uq_subgroup_classification_rule_by_ids")
  @@index([systemId, parentGroupId, priority], map: "idx_subgroup_classification_rule_by_parent_id")
  @@map("subgroup_classification_rules")
  @@schema("equivalentes_app")
}

model ExchangeSourcePriority {
  id           BigInt   @id @default(autoincrement())
  systemId     String   @map("system_id")
  dataSourceId Int      @map("data_source_id")
  priority     Int      @default(100)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([systemId, dataSourceId], map: "uq_exchange_source_priorities_system_source")
  @@index([systemId, isActive, priority], map: "idx_exchange_source_priorities_lookup")
  @@map("exchange_source_priorities")
  @@schema("equivalentes_app")
}

model ExchangeBucketProfile {
  id             BigInt   @id @default(autoincrement())
  profileVersion String   @map("profile_version")
  systemId       String   @map("system_id")
  bucketType     String   @map("bucket_type")
  bucketId       Int      @map("bucket_id")
  parentGroupId  Int?     @map("parent_group_id")
  choG           Decimal  @map("cho_g") @db.Decimal(10, 2)
  proG           Decimal  @map("pro_g") @db.Decimal(10, 2)
  fatG           Decimal  @map("fat_g") @db.Decimal(10, 2)
  kcal           Int
  sampleSize     Int      @map("sample_size")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([profileVersion, systemId, bucketType, bucketId], map: "uq_exchange_bucket_profiles_version_system_bucket")
  @@index([systemId, profileVersion, bucketType, bucketId], map: "idx_exchange_bucket_profiles_lookup")
  @@map("exchange_bucket_profiles")
  @@schema("equivalentes_app")
}

model GeneratedPlan {
  id          String   @id @default(uuid())
  cid         String
  countryCode String   @map("country_code") @db.Char(2)
  stateCode   String   @map("state_code")
  systemId    String   @map("system_id")
  formulaId   String   @map("formula_id")
  inputs      Json
  targets     Json
  equivalents Json
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  system          ExchangeSystem @relation(fields: [systemId], references: [id], onDelete: Restrict)
  formula         KcalFormula    @relation(fields: [formulaId], references: [id], onDelete: Restrict)
  recommendations GeneratedPlanRecommendation[]

  @@index([cid, createdAt], map: "idx_generated_plans_cid_created_at")
  @@map("generated_plans")
  @@schema("equivalentes_app")
}

model GeneratedPlanRecommendation {
  id         BigInt   @id @default(autoincrement())
  planId     String   @map("plan_id")
  foodId     Int      @map("food_id")
  groupCode  String   @map("group_code")
  rankScore  Decimal  @map("rank_score") @db.Decimal(10, 2)
  reasons    Json
  isExtended Boolean  @default(false) @map("is_extended")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  plan GeneratedPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, groupCode], map: "idx_plan_recommendations_plan_group")
  @@map("generated_plan_recommendations")
  @@schema("equivalentes_app")
}

model Lead {
  id        String   @id @default(uuid())
  cid       String?
  name      String
  email     String?
  whatsapp  String?
  birthDate DateTime? @map("birth_date") @db.Date
  waistCm   Decimal?  @map("waist_cm") @db.Decimal(6, 2)
  hasDiabetes Boolean  @default(false) @map("has_diabetes")
  hasHypertension Boolean  @default(false) @map("has_hypertension")
  hasDyslipidemia Boolean  @default(false) @map("has_dyslipidemia")
  trainingWindow String @default("none") @map("training_window")
  usesDairyInSnacks Boolean @default(true) @map("uses_dairy_in_snacks")
  termsAccepted Boolean  @default(false) @map("terms_accepted")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([cid], map: "idx_leads_cid")
  @@map("leads")
  @@schema("equivalentes_app")
}
